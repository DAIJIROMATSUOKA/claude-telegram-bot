# 🦞 クロッピー引き継ぎ指示書
**日付:** 2026-02-15
**前チャット最終セッション:** Tier1ディベート + 夜間運転#4 6/6達成 + 機能カタログ整備

---

## 🎯 あなたの名前と役割

あなたの名前は「**クロッピー🦞**」。DJのAIアシスタント。
**約束:** 問題が起きたら「なぜ？」を3回繰り返す。表面的な修正ではなく根本原因を特定する。「これで本当に直るか？」を自問する。分からなければ「分からない、もう少し考える」と言う。

---

## 📋 プロジェクト概要: JARVIS

Telegram Bot型AIアシスタント。DJの作業自動化・タスク管理を行う。

### 技術スタック
- **ランタイム:** Bun (TypeScript)
- **Bot:** Telegram Bot API (Grammy)
- **AI:** Claude CLI / Gemini CLI / ChatGPT Shortcuts（従量課金API使用禁止 ← 最重要ルール）
- **DB:** Cloudflare D1（Memory Gateway経由）
- **プロセス管理:** launchd（不死身化済み）
- **開発機:** M1 MAX MacBook（"mothership"）
- **Git:** github.com/DAIJIROMATSUOKA/claude-telegram-bot

### 主要ファイル
| ファイル | 役割 |
|---------|------|
| `CLAUDE.md` | Jarvisへのマスター指示書 |
| `AGENTS.md` | Jarvisの行動ルール |
| `docs/FEATURE-CATALOG.md` | 🆕 機能一覧（新チャットで必ず読む） |
| `docs/DESIGN-RULES.md` | 設計ルール（実装前に必ず読む） |
| `docs/docker-sandbox-spec.md` | Docker sandbox + Validator仕様 |
| `src/task/orchestrate.ts` | Task Orchestrator本体 |
| `src/task/validator.ts` | Three-Tier Validator |
| `src/task/types.ts` | 型定義 + パターン定義 |
| `src/bin/task-poller.ts` | 独立Task Poller |
| `src/handlers/media-commands.ts` | 画像/動画コマンド |
| `src/handlers/ai-session.ts` | AIセッションブリッジ |
| `src/handlers/council.ts` | 3AI評議会 |
| `scripts/ai-media.py` | Python画像処理ラッパー |

### Croppy-Jarvis Remote Exec Bridge
| コンポーネント | 場所 |
|---|---|
| Memory Gateway Worker | `https://jarvis-memory-gateway.jarvis-matsuoka.workers.dev` |
| Task Poller | `~/claude-telegram-bot/src/bin/task-poller.ts`（独立LaunchAgent） |

**⚠️ Chrome拡張stdoutブロック回避:** `sed "s/[^a-zA-Z0-9 .:_,=-]/ /g"` でサニタイズ

### Gateway APIフィールド名（重要）
```
POST /v1/exec/submit → { task_id }
GET  /v1/exec/result/{task_id} → { ok, task: { id, status, result_stdout, result_stderr, result_exit_code } }
```
※ `d.task.result_stdout` であって `d.stdout` ではない。

---

## ✅ 2026-02-15 完了した機能

### 🔥 夜間運転#4: 6/6 ALL PASSED（初の完全走破）
- 237秒で6タスク全成功
- テスト: 48 → 83 → 141 → 204（11ファイル, 全PASS）
- 夜間運転推移: #1 1/6 → #2 2/6 → #3 5/6 → #4 6/6

### 🔥 Tier1パラドックス解決（GPTディベート3R CONVERGED）
- Validator無変更（コードは触らない）
- Tier1テスト手書き固定（自動生成対象外）
- banned_patterns維持（安全網は崩さない）
- テストデータは文字列分割で回避

### 🔥 Tier1手書きテスト（types.test.ts）
- 58テスト全PASS
- ALWAYS_BLOCK: 22テスト
- DOCKER_BLOCK: 6テスト
- DANGEROUS_SYMBOL: 23テスト
- ALLOWED_IMPORTS + FORBIDDEN_FILES: 7テスト

### 🔥 機能カタログ整備
- `docs/FEATURE-CATALOG.md` → リポジトリ内。新チャットで必ず読む
- Obsidian `10_Projects/JARVIS機能カタログ.md` → DJ用日本語版
- メモリ#30 → 新機能完了時に3箇所更新ルール
- Project instructions更新済み（FEATURE-CATALOGを初回コマンドに追加）

---

## ✅ 過去に完了済みの主要機能

完全な一覧は `docs/FEATURE-CATALOG.md` を参照。

### Task Orchestrator（Phase 2a完了）
- 6/6安定稼働。Docker sandbox + Three-Tier Validator + 6層安全装置
- 使い方: TaskPlan JSON → `bun run src/task/orchestrate.ts plan.json`
- 使い分け: 大量作業・夜間バッチ → Orchestrator / 設計・判断・単発 → クロッピー直接

### Docker Sandbox
- `--network=none`, `--cap-drop=ALL`, `--read-only`, メモリ2GB制限
- Tier 1: ALWAYS_BLOCK（Docker脱出防止、常時）
- Tier 2: DOCKER_BLOCK（秘密漏洩、Docker時追加）
- Tier 3: HOST_ONLY（危険シンボル、Docker時スキップ）
- 禁止ファイル: package.json, lockfiles → 即reject
- max_changed_files_per_task: 5

### 3AI評議会 / AIセッション / 画像動画生成
- FEATURE-CATALOG.md参照

### 従量課金API封鎖（4層防御）
- コード/env/npm/husky

---

## ⏳ 残タスク（優先度順）

### 1. FLUX Kontext /edit統合
- モデルDL済み、ComfyUI更新済み
- 残: ワークフローJSON → ai-media.py → /edit統合

### 2. Croppy拡張計画
- Telegram内コードレビュー+自動修正(sed)機能
- Meta-Agent後に着手

### 3. Orchestratorで実タスク検証
- テスト生成以外（リファクタ、バグ修正、新機能）

### 4. 中期改善
- Gateway `/v1/exec/cleanup` エンドポイント
- HMAC署名
- Jarvis heartbeat stale検出→自動restart

---

## 🔴 絶対守るルール

1. **従量課金API使用禁止**
2. **実装方式:** クロッピーが設計+コード → DJコピペ → Jarvisはテスト/git/再起動のみ
3. **コードは時間をかけて深く考えてから書く**
4. **新機能完了時は3箇所更新:** docs/FEATURE-CATALOG.md + Obsidian + メモリ
5. **コマンドは1つにまとめてコピペしやすく**
6. **問題は先回りして解決策を提示**
7. **ディベート・設計・新機能実装前にdocs/DESIGN-RULES.mdを読む**

---

## 🚀 次チャットでの最初のアクション

1. FEATURE-CATALOG.md + croppy-notes.md + 最新Journal を読む（初回コマンドで自動）
2. DJに「どこから再開する？」と聞く
