# Task Orchestrator Phase 2/3 ロードマップ仕様書

**作成日:** 2026-02-14
**ディベート:** ChatGPT×2 + Gemini×2 + クロッピー統合（4ラウンド）
**判定:** 全員GO → DJ承認

---

## Phase構造（最終決定）

### Phase 1（✅ 完了）

DJ監視下、worktree + env隔離。

| 項目 | 内容 |
|------|------|
| 隔離 | git worktree + HOME=worktree + env最小化 + proxy無効化 |
| 検証 | AST Import解析 + 危険シンボルregex + banned_patterns + bun test |
| エラー時 | 即停止 + git checkout rollback |
| 夜間 | ❌ 禁止 |
| テスト | スモークテスト2/2 PASS（成功パス + 防御パス） |

**移行条件（Phase 1 → 2a）:**
- 実タスク成功5件以上
- 種類3種以上（既存修正 / 新規追加 / テスト追加 / 依存更新 / リファクタ から3つ）
- 失敗系テスト4本PASS:
  1. 危険シンボル検知 → 停止
  2. テスト失敗 → rollback
  3. 不許可import → 停止
  4. 2連続失敗 → 全停止（Phase 2a実装後に追加）

**並行タスク:** Docker PoC実施（Phase 1期間中に裏で検証）

---

### Phase 2a: 制御ロジック確立

ホスト環境のまま（隔離レベルはPhase 1と同じ）。「暴走しない安全装置」を完成させる。

**実装項目:**

| 項目 | 仕様 |
|------|------|
| 1回リトライ | 失敗理由（testログ/AST差分/危険検知）を要約し再プロンプト → 1回のみリトライ → 再失敗ならタスク停止 |
| 2連続失敗全停止 | 全体で2タスク連続失敗 → 全MicroTask停止 + Telegram通知 |
| スキップ | **禁止**（Phase 3 DAG化まで） |
| リソース上限 | ディスク使用量 / 生成ファイル数 / 変更行数 / 実行時間 — 超過時即停止+rollback |
| テスト行数チェック | テストファイルの行数が異常に少ない/多い場合に警告 |
| Health Check | 夜間運転開始前に `claude --version` + ダミープロンプト("hello")で生存確認 |
| スリープ防止 | `caffeinate -i -s` でラップ実行 |
| worktreeクリーナー | 起動時に `git worktree prune` + 古いworktreeディレクトリ強制削除 |
| D1ローカルバッファ | 実行中ログはローカルJSONL → 成功/失敗の区切りでD1へ非同期Sync |

**夜間:** 1h上限

**移行条件（Phase 2a → 2b）:**
- 夜間1h × 3回の無人運転で正常動作
- Docker PoC判定完了（可/不可の結論）

---

### Phase 2b: 環境隔離

Phase 2aの制御ロジックを隔離環境へ移植。

**Docker可の場合:**
- Docker隔離 + ネットワーク制御（Anthropic APIのみ許可）
- M1 VirtioFS I/O遅延のチューニング
- Claude CLI認証のコンテナ内持ち込み検証済み

**Docker不可の場合（フォールバック優先順位）:**
1. 専用OSユーザー + ACL + sudo禁止 + ulimit制限 + 対象repo以外アクセス不可
2. 軽量VM（Tart）常駐1台固定運用
3. venv（補助のみ、Python系テスト安定化用）

**夜間:** 2-4h（制限緩和）

**移行条件（Phase 2b → 3）:**
- 夜間2h × 3回の無人運転で正常動作
- リソース上限到達0回
- 異常終了0回

---

### Phase 3: 一晩自律運転

**追加実装:**

| 項目 | 仕様 |
|------|------|
| DAG依存関係 | MicroTask間の依存をDAG化。前提失敗 → 後続スキップ |
| チェックポイント | Nタスクごとに中間安定コミット。失敗時は直前checkpointへ復帰 |
| 朝サマリー自動生成 | 成功/失敗/差分/原因/次アクション — 上位3に集約表示 |

**完了条件（全て満たす）:**

| カテゴリ | 条件 |
|----------|------|
| 安全性 | リソース上限到達0回 + 異常終了0回 + rollback失敗0回 |
| 処理能力 | 1晩で10タスク以上処理 |
| 安定性 | 直近20タスクの成功率80%以上 |
| 再現性 | 連続3晩同条件で同水準達成 |

→ 上記全達成で「一晩自律運転OK」。DJは安心して寝られる。

---

## 技術リスクと対策

| リスク | 深刻度 | 対策 |
|--------|--------|------|
| Claude CLIの破壊的変更 | 🔴 High | 夜間運転前Health Check（version確認+ダミープロンプト） |
| M1 Macスリープ | 🟡 Medium | `caffeinate -i -s` + 可能なら有線LAN |
| Git worktree肥大化 | 🟢 Low | 起動時prune + 古いディレクトリ強制削除 |
| D1レート制限 | 🟡 Medium | ローカルJSONLバッファ → 非同期Sync |
| Docker M1 I/O遅延 | 🟡 Medium | Phase 2b移植時にチューニング。不可なら専用ユーザー |

---

## 却下した案と理由

| 却下案 | 理由 | 出典 |
|--------|------|------|
| Phase 1.5（Docker PoC独立Phase） | 直列にするとブロッキング要因。並行で十分 | Gemini R1 |
| macOS sandbox / sandbox-exec | ドキュメント乏しくM1 SIPで茨の道 | Gemini R1 |
| DAG+チェックポイントをPhase 2に | オーバースペック。ジョブ管理システムの複雑度が安定性を損なう | Gemini R1 |
| MicroTask失敗時スキップ | 依存崩壊リスク。DAG化（Phase 3）まで禁止 | ChatGPT R2 |
| 即停止のみ（リトライなし） | 夜間運転で価値がない。偶発失敗を1回で吸収すべき | ChatGPT R2 |
| venvでファイルシステム隔離 | Python依存管理のみ。Claude CLIはnpmなので守備範囲外 | ChatGPT R2 |
| Phase 2/3を分けない（一気にDocker） | Dockerが詰む可能性あり。段階的に進むべき | ChatGPT R1 |

---

## ディベート参加者と投票

| 参加者 | R1 | R2 | 最終 |
|--------|----|----|------|
| ChatGPT🤖 | 5論点に修正案 | 3論点収束 | ✅ GO |
| Gemini💎 | Phase 1.5削除+sandbox反対+DAG先送り | Phase 2分割+技術リスク4点 | ✅ GO（Phase 2分割条件付き） |
| クロッピー🦞 | 統合 | 統合 | ✅ GO |
| DJ | — | — | ✅ GO |

---

## 次のアクション

1. **Phase 1の実タスク投入開始**（移行条件: 5件+3種+失敗系テスト）
2. **Docker PoC並行実施**（Claude CLI認証+最小タスク×3+性能測定）
3. **Phase 2a設計着手**は実タスク3件完了後（知見を溜めてから）
