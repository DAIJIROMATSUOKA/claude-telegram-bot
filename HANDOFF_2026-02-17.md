# 🦞 クロッピー引き継ぎ指示書
**日付:** 2026-02-17
**前チャット:** /code実装 → SIGTERM修正 → Croppy自律ループ設計

---

## 🎯 あなたの名前と役割

あなたの名前は「**クロッピー🦞**」。DJのAIアシスタント。
**約束:** 問題が起きたら「なぜ？」を3回繰り返す。表面的な修正ではなく根本原因を特定する。「これで本当に直るか？」を自問する。分からなければ「分からない、もう少し考える」と言う。

---

## ✅ 2026-02-17 完了した機能

### 1. 🔥 /code コマンド実装
**コミット:** `d33649c81700239044cd772c9f67d46e0393ca49`

Telegram → Jarvis → Claude Code 直接起動の新レーン。
- `src/handlers/code-command.ts` 新規作成
- `src/index.ts` にコマンド登録
- nohupパターンでClaude Codeを独立プロセスとしてspawn
- croppy-done.sh（Stop hook）経由でTelegram通知
- exec bridgeは併存（claude.ai経由レーン）

### 2. 🔧 重複通知バグ修正
**コミット:** `08b925206d3043f3d757b86fc991fa17e234b567`

- `scripts/auto-handoff.py` からTelegram通知を削除
- croppy-done.shが通知を担当 → auto-handoff.pyとの二重通知を解消

### 3. 🔧 /edit SIGTERMバグ — 根本原因分析 + Fix 1-5 実装
**分析コミット:** `a690fb328cc9bab2df0ba8ea027536382b3d7f38`
**修正コミット:** `596375fb0e736ef5f8fc8134cb4af34ea6c90003`

**根本原因特定:** ComfyUIプロセスが完了後も残留 → ai-media.pyのactivity timeoutに引っかかる → SIGTERMで強制終了

**実装した修正（Fix 1-5）:**
| Fix | 内容 | ファイル |
|-----|------|---------|
| Fix 1 | Graceful shutdown — SIGTERMハンドラ追加、cleanup順序改善 | scripts/ai-media.py |
| Fix 2 | Activity timeout防止 — ComfyUI進捗をactivity updateとして記録 | scripts/ai-media.py |
| Fix 3 | ComfyUIプロセス明示的終了 — 完了後に子プロセスを確実にkill | scripts/ai-media.py |
| Fix 4 | Grammy timeout延長（300s） — 前回コミット `72d0be2` で対応済み | src/handlers/media-commands.ts |
| Fix 5 | エラーハンドリング強化 — SIGTERM時のリソースリーク防止 | scripts/ai-media.py |

### 4. 📋 Croppy自律ループ仕様書（Plan D）
**コミット:** `aebd65d858c83198ee8b85722a9ac8cf55e54d6f`

- `docs/croppy-loop-spec.md` 新規作成
- 状態永続化: `autonomous/state/M1.md` をsingle source of truth
- Auto-recovery: watchdogがクラッシュ検知 → 自動再spawn
- 3段階ループ: --check → --next → --fire のサイクル
- Phase 1テスト成功確認済み（`7bfbd925`）

### 5. 📄 FEATURE-CATALOG.md 更新3件
| コミット | 内容 |
|---------|------|
| `9be83304fee20b29ecadb5db7ce9bcd1d14ed6c5` | /code コマンドセクション追加 |
| `51c67a395e8ebf009479d9443663f5fdd33d0571` | Croppy自律ループ（Plan D）セクション追加 |
| `f450d259c6dab0cfc54edfa46d10fbb2bb74bf25` | 全セクション監査レポート |

### 6. 📄 Phase 1テスト結果追記
**コミット:** `7bfbd925318470c5583da6e1c28f64d017e00f2d`
- `docs/croppy-loop-spec.md` にPhase 1の1ステップ自律ループ成功結果を記録

---

## 𓋋 仕様書・設計ドキュメント
| ファイル | 内容 |
|---------|------|
| `docs/croppy-loop-spec.md` | Croppy自律ループ仕様書（Phase 1テスト結果付き） |
| `docs/edit-sigterm-analysis.md` | /edit SIGTERMバグ根本原因分析+修正一覧 |
| `docs/jarvis-v2-spec.md` | v2全決定事項+E2E結果 |
| `docs/FEATURE-CATALOG.md` | リポジトリ内機能一覧（2026-02-17更新） |
| `docs/DESIGN-RULES.md` | 設計原則（実装前に必読） |
| `autonomous/state/M1.md` | Croppy自律ループ状態ファイル（single source of truth） |

---

## ⏳ 残タスク（優先度順）

### 1. 🔴 git push（全ローカルコミット）
- 2026-02-16〜17の全コミットがlocal only
- `git push origin main` で一括push必要

### 2. 🟡 Croppy自律ループ Phase 2-3
- Phase 2: 複数ステップ連続実行テスト
- Phase 3: エラーリカバリ+自動再spawn検証
- 仕様は `docs/croppy-loop-spec.md` 参照

### 3. 🟡 /edit SIGTERMバグ — 実戦検証
- Fix 1-5実装済み。Telegram経由での実テストがまだ
- テスト方法: `/edit --steps 1` で短い生成を実行 → SIGTERMが出ないことを確認

### 4. 🟡 未コミット変更の整理
- `autonomous/state/M1.md` — ループ状態ファイル（進行中タスクの状態）
- `src/task/health-check.test.ts` — テスト変更
- `src/tests/why-command.test.ts` — テスト変更
- `.env.example`, `.env.save` — 環境設定

### 5. 🟢 memory-gateway git push
- `~/memory-gateway/` で `git push` 必要（前日から引き継ぎ）

### 6. 🟢 Voice transcription ローカル化
- OpenAI API依存 → Whisper.cppへの移行候補
- 優先度低

---

## 🔴 絶対守るルール

1. **従量課金API使用禁止** — CLI経由のみ
2. **実装方式:** 🦞が設計+コード → DJコピペ or v2パイプライン(claude -p)
3. **コードを書く前に深く考える。急がない。**
4. **docs/DESIGN-RULES.md を実装前に必ず読む**
5. **Telegram通知必須**（完了・異常時）
6. **「完璧」と言わない** — ①実装 ②テスト ③報告

---

## 💡 重要な教訓

### 2026-02-17の教訓
- **/edit SIGTERM根本原因:** ComfyUI完了後の残留プロセス → activity timeout → SIGTERM。表面的なtimeout延長では解決しない
- **重複通知の罠:** croppy-done.sh + auto-handoff.py が両方Telegram通知 → 片方を削除して一元化
- **状態ファイル設計:** M1.mdをsingle source of truthにすることで、クラッシュ後もどこから再開すべきか分かる
- **FEATURE-CATALOG監査:** 定期的に全セクションの正確性を確認する習慣が大事

### 2026-02-16の教訓（引き継ぎ）
- **nohup必須:** Poller子プロセスでclaude -p → メモリ圧迫でSIGTERM → nohupで独立化
- **--dangerously-skip-permissions必須:** 非対話環境でパーミッション確認ハング
- **ISO日付バグ:** Gateway cleanup SQLでISO形式とSQLite datetime()は比較不可

---

## 🚀 次チャットでの最初のアクション

1. AI_MEMORYを確認
2. DJに「どこから再開する？」と聞く
3. 最優先候補:
   - **A) git push** → ローカルに溜まったコミットを一括push
   - **B) Croppy自律ループ Phase 2** → 複数ステップ連続テスト
   - **C) /edit SIGTERM実戦テスト** → Fix 1-5の効果検証
