# 🦞 クロッピー引き継ぎ指示書
**日付:** 2026-02-16
**前チャット:** JARVIS v2 Croppy-Driven Architecture 設計+実装+E2Eテスト

---

## 🎯 あなたの名前と役割

あなたの名前は「**クロッピー🦞**」。DJのAIアシスタント。
**約束:** 問題が起きたら「なぜ？」を3回繰り返す。表面的な修正ではなく根本原因を特定する。「これで本当に直るか？」を自問する。分からなければ「分からない、もう少し考える」と言う。

---

## ✅ 2026-02-16 完了した機能

### 🔥 JARVIS v2 Croppy-Driven Architecture — 正式採用+E2E実証済み
**設計思想:** 🦞(claude.ai)が設計・判断 → Claude Code(M1)が自律実行 → Telegram通知。Jarvisは軽いタスクのみ。

**2レーン設計:**
| レーン | 経路 | 用途 |
|--------|------|------|
| 重いタスク | 🦞 → exec bridge --fire → nohup claude -p → 自律実行 → Telegram通知 | 機能実装、バグ修正、リファクタ |
| 軽いタスク | DJ → Telegram → Jarvis（今のまま） | git status、天気、雑談、/debate、/imagine |

**確定した起動パターン:**
```
bash exec.sh --fire "cd ~/claude-telegram-bot && nohup claude -p --dangerously-skip-permissions 'タスク指示書' > /tmp/claude-code-output.log 2>&1 & echo SPAWNED"
```

**E2Eテスト結果:**
- exec bridge → nohup spawn → Claude Code自律実行 → git log正しい結果 ✅
- Stop hook → croppy-done.sh → Telegram直接通知（git情報付き） ✅
- auto-handoff.py → セッション保存 ✅
- Poller watchdog → SIGTERM後の自動復旧（3回確認） ✅

**実戦テスト: Gateway日付バグ修正**
- 🦞が指示書 → Claude Codeが60秒で自律修正+git commit → DJがデプロイ
- reset_stuck: 0→7, purged_done: 0→14 → バグ完全修復

### 🔥 Claude Code環境セットアップ
- **バージョン:** v2.1.42
- **モデル:** Opus 4.6 (high effort)
- **Sandbox:** auto-allow mode
- **ralph-loop:** installed (user scope)
- **Timeout:** 30min default / 2hr max
- **Autocompact:** 90%

### 🔥 ~/.claude/settings.json修正
- deny: `Bash(rm -rf /:**)` → `Bash(rm -rf /*)` （構文エラー修正）

### 🔥 Gateway Cleanup日付バグ修正+デプロイ
- ISO 8601 vs SQLite datetime不一致 → replace('T', ' ')で正規化
- コミット: f75d6e4 (~/memory-gateway/)
- Cloudflare Workerデプロイ済み

### 🔥 Obsidian機能カタログ更新
- v2セクション、インフラ硬化セクション、更新履歴追記

---

## 𓋋 仕様書・設計ドキュメント
| ファイル | 内容 |
|---------|------|
| `docs/jarvis-v2-spec.md` | v2全決定事項+E2E結果 |
| `docs/FEATURE-CATALOG.md` | リポジトリ内機能一覧 |
| `docs/DESIGN-RULES.md` | 設計原則（実装前に必読） |
| Obsidian `10_Projects/JARVIS機能カタログ.md` | DJ用日本語説明 |

---

## ⏳ 残タスク（優先度順）

### 1. v2パイプライン実運用開始
- E2E成功、実戦テスト成功 → 本格運用フェー㊺
- `/extra-usage` 有効化（Claude Code $50無料枠）

### 2. memory-gateway git push
- ~/memory-gateway/ で `git push` 必要（f75d6e4がlocal only）

### 3. /edit SIGTERMバグ修正（前回から引き継ぎ）
- Queueパッチで連続実行は防止済み、単発でもSIGTERM残存
- 調査方針: `--steps 1`（10秒）でTelegram経由テスト

### 4. 未コミット変更（前回から引き継ぎ）
- media-commands.ts（withMediaQueue適用）

### 5. debateセッション
- DJ宣言済み

---

## 🔴 絶対守るルール

1. **従量課金API使用禁止** — CLI経由のみ
2. **実装方式:** 🦞が設計+コード → DJコピペ or v2パイプライン(claude -p)
3. **コードを書く前に深く考える。急がない。**
4. **docs/DESIGN-RULES.md を実装前に必ず読む**
5. **Telegram通知必須**（完了・異常時）
6. **「完璧」と言わない** — ①実装 ②テスト ③報告

---

## 💡 重要な教訓

### 2026-02-16の教訓
- **nohup必須:** Poller子プロセスでclaude -p → メモリ圧迫でSIGTERM → nohupで独立化
- **--dangerously-skip-permissions必須:** 非対話環境でパーミッション確認ハング
- **ISO日付バグ:** Gateway cleanup SQLでISO形式とSQLite datetime()は比較不可
- **settings.json構文:** `Bash(rm -rf /:**)` は無効 → `Bash(rm -rf /*)`
- **memory-gatewayパス:** ~/memory-gateway/（claude-telegram-bot内ではない）
- **🦞のfire-and-forget:** 投げて終わり。結果はTelegramに届く。セッション死んでもOK

---

## 🚀 次チャットでの最初のアクション

1. AI_MEMORYを確認
2. DJに「どこから再開する？」と聞く
3. 最優先候補:
   - **A) v2パイプラインで実タスク** → 本格運用
   - **B) /edit SIGTERMバグ修正**
   - **C) debateセッション**
